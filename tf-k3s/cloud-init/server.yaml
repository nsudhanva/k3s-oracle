#cloud-config
package_update: true
packages:
  - curl
  - iptables-persistent

write_files:
  - path: /var/lib/rancher/k3s/server/manifests/argocd.yaml
    owner: root:root
    permissions: '0644'
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: argocd
        namespace: kube-system
      spec:
        chart: argo-cd
        repo: https://argoproj.github.io/argo-helm
        targetNamespace: argocd
        createNamespace: true
        valuesContent: |-
          server:
            extraArgs:
              - --insecure
            config:
              kustomize.buildOptions: "--enable-helm"
            service:
              type: ClusterIP

  - path: /var/lib/rancher/k3s/server/manifests/root-app.yaml
    owner: root:root
    permissions: '0644'
    content: |
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: root-app
        namespace: argocd
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        project: default
        source:
          repoURL: ${git_repo_url}
          targetRevision: HEAD
          path: argocd
        destination:
          server: https://kubernetes.default.svc
          namespace: default
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          syncOptions:
            - CreateNamespace=true

  - path: /var/lib/rancher/k3s/server/manifests/argocd-repo-creds.yaml
    owner: root:root
    permissions: '0600'
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: repo-creds
        namespace: argocd
        labels:
          argocd.argoproj.io/secret-type: repository
      type: Opaque
      stringData:
        url: ${git_repo_url}
        username: ${git_username}
        password: ${git_pat}

  - path: /var/lib/rancher/k3s/server/manifests/regcred.yaml
    owner: root:root
    permissions: '0600'
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: regcred
        namespace: default
      type: kubernetes.io/dockerconfigjson
      stringData:
        .dockerconfigjson: |
          {
            "auths": {
              "ghcr.io": {
                "username": "${git_username}",
                "password": "${git_pat}",
                "auth": "${base64encode("${git_username}:${git_pat}")}"
              }
            }
          }

  - path: /var/lib/rancher/k3s/server/manifests/cloudflare-secret.yaml
    owner: root:root
    permissions: '0600'
    content: |
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cert-manager
      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api-token-secret
        namespace: cert-manager
      type: Opaque
      stringData:
        api-token: ${cloudflare_api_token}
      ---
      apiVersion: v1
      kind: Namespace
      metadata:
        name: external-dns
      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api-token-secret
        namespace: external-dns
      type: Opaque
      stringData:
        api-token: ${cloudflare_api_token}

runcmd:
  - iptables -P INPUT ACCEPT
  - iptables -P FORWARD ACCEPT
  - iptables -F INPUT
  - iptables -F FORWARD
  - netfilter-persistent save
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --disable traefik --tls-san ${public_ip}" K3S_TOKEN=${k3s_token} sh -
